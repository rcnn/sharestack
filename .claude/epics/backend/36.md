---
name: 内容分类管理系统
status: backlog
created: 2025-09-15T02:51:00Z
github: https://github.com/rcnn/sharestack/issues/36
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: 内容分类管理系统

## Description

实现内容分类管理功能，包括分类的创建、管理、层级结构维护，以及内容与分类的关联管理。支持多级分类和分类统计功能。

## Acceptance Criteria

- [ ] 完成分类列表API (/api/v1/categories/list)
- [ ] 完成分类创建API (/api/v1/categories/create)
- [ ] 完成分类更新API (/api/v1/categories/update)
- [ ] 完成分类删除API (/api/v1/categories/delete)
- [ ] 完成内容分类关联API (/api/v1/contents/{id}/categories)
- [ ] 实现分类层级结构管理
- [ ] 实现分类统计功能
- [ ] 编写完整的测试用例

## Technical Details

### 分类数据模型设计

#### Categories表结构
```sql
CREATE TABLE categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    parent_id BIGINT NULL,
    sort_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_parent_id (parent_id),
    INDEX idx_sort_order (sort_order),
    INDEX idx_name (name),
    FOREIGN KEY (parent_id) REFERENCES categories(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

#### Content_Categories关联表
```sql
CREATE TABLE content_categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    category_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_content_category (content_id, category_id),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

### API接口规范

#### 分类管理接口
- **GET /api/v1/categories/list**
  - 查询参数: parent_id, is_active, include_children
  - 响应: 分类树结构或平铺列表
  - 权限: 公开接口

- **POST /api/v1/categories/create**
  - 请求体: name, description, parent_id, sort_order
  - 响应: 201 Created + 分类详情
  - 权限: 内容创作者或管理员

- **PUT /api/v1/categories/{id}/update**
  - 请求体: name, description, sort_order, is_active
  - 响应: 200 OK + 更新后分类
  - 权限: 分类创建者或管理员

- **DELETE /api/v1/categories/{id}/delete**
  - 软删除，检查是否有内容关联
  - 响应: 204 No Content
  - 权限: 分类创建者或管理员

#### 内容分类关联接口
- **GET /api/v1/contents/{id}/categories**
  - 获取内容的所有分类
  - 响应: 200 OK + 分类列表

- **POST /api/v1/contents/{id}/categories**
  - 请求体: category_ids (数组)
  - 为内容添加分类
  - 响应: 201 Created

- **DELETE /api/v1/contents/{id}/categories/{category_id}**
  - 移除内容的指定分类
  - 响应: 204 No Content

### 分类层级管理

#### 树结构查询优化
```python
def get_category_tree(parent_id=None):
    """获取分类树结构"""
    # 使用递归CTE或闭包表模式
    pass

def get_category_path(category_id):
    """获取分类完整路径"""
    # 返回从根到当前分类的完整路径
    pass
```

#### 分类统计
- 每个分类下的内容数量
- 分类的子分类数量
- 分类的使用频率统计

### 业务规则

1. **层级限制**: 最多支持3级分类
2. **命名唯一性**: 同级分类名称不能重复
3. **删除保护**: 有内容关联的分类不能删除
4. **移动限制**: 不能将分类移动到自己的子分类下
5. **排序管理**: 支持拖拽排序，自动更新sort_order

## Dependencies

- [ ] Task 001: 后端基础架构
- [ ] 用户管理模块 (创建者权限)
- [ ] 数据库设计完成

## Effort Estimate

- Size: M
- Hours: 18小时
- Parallel: true

## Definition of Done

- [ ] 所有分类管理API接口实现完成
- [ ] 分类层级结构正确实现
- [ ] 内容分类关联功能正常
- [ ] 分类统计功能正确
- [ ] 业务规则验证通过
- [ ] 单元测试覆盖率达到90%
- [ ] API文档更新完成
- [ ] 性能测试通过

## Implementation Notes

### Service层设计
```python
class CategoryService:
    def create_category(self, category_data, user_id):
        """创建分类"""
        pass

    def get_category_tree(self, parent_id=None):
        """获取分类树"""
        pass

    def update_category(self, category_id, update_data, user_id):
        """更新分类"""
        pass

    def delete_category(self, category_id, user_id):
        """删除分类"""
        pass

    def assign_categories_to_content(self, content_id, category_ids):
        """为内容分配分类"""
        pass
```

### 缓存策略
- `categories:tree`: 完整分类树 (TTL: 1小时)
- `categories:stats:{id}`: 分类统计数据 (TTL: 30分钟)
- `content:categories:{id}`: 内容分类关联 (TTL: 1小时)

### 错误处理
- 400: 分类参数无效
- 404: 分类不存在
- 409: 分类名称冲突或循环引用
- 422: 业务规则违反 (如删除有内容的分类)