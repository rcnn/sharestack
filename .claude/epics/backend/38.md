---
name: 内容状态管理系统
status: backlog
created: 2025-09-15T02:51:00Z
github: https://github.com/rcnn/sharestack/issues/38
depends_on: [001, 34]
parallel: true
conflicts_with: []
---

# Task: 内容状态管理系统

## Description

实现内容生命周期状态管理，包括草稿、发布、定时发布、归档等状态转换，以及状态流转的权限控制和日志记录。

## Acceptance Criteria

- [ ] 完成内容发布API (/api/v1/contents/{id}/publish)
- [ ] 完成草稿管理API (/api/v1/contents/{id}/draft)
- [ ] 完成定时发布API (/api/v1/contents/{id}/schedule)
- [ ] 完成内容归档API (/api/v1/contents/{id}/archive)
- [ ] 实现状态流转控制规则
- [ ] 实现定时任务处理
- [ ] 实现状态变更日志
- [ ] 编写完整的测试用例

## Technical Details

### 内容状态模型扩展

#### 对Contents表的扩展
```sql
ALTER TABLE contents ADD COLUMN (
    status ENUM('draft', 'pending_review', 'published', 'scheduled', 'archived', 'rejected') DEFAULT 'draft',
    published_at TIMESTAMP NULL,
    scheduled_at TIMESTAMP NULL,
    archived_at TIMESTAMP NULL,
    review_status ENUM('not_required', 'pending', 'approved', 'rejected') DEFAULT 'not_required',
    reviewed_by BIGINT NULL,
    reviewed_at TIMESTAMP NULL,
    review_notes TEXT,
    INDEX idx_status (status),
    INDEX idx_published_at (published_at),
    INDEX idx_scheduled_at (scheduled_at),
    FOREIGN KEY (reviewed_by) REFERENCES users(id)
);
```

#### Content_Status_Log状态日志表
```sql
CREATE TABLE content_status_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    from_status VARCHAR(50),
    to_status VARCHAR(50) NOT NULL,
    changed_by BIGINT NOT NULL,
    change_reason VARCHAR(255),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_content_id (content_id),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (changed_by) REFERENCES users(id)
);
```

### API接口规范

#### 状态管理接口
- **POST /api/v1/contents/{id}/publish**
  - 请求体: publish_immediately (boolean, 默认true)
  - 将草稿或待审核内容发布
  - 响应: 200 OK + 更新后内容
  - 权限: 内容作者或管理员

- **POST /api/v1/contents/{id}/draft**
  - 将已发布内容撤回到草稿状态
  - 请求体: reason (撤回原因)
  - 响应: 200 OK + 更新后内容
  - 权限: 内容作者或管理员

- **POST /api/v1/contents/{id}/schedule**
  - 请求体: scheduled_at (ISO 8601时间格式)
  - 设置内容定时发布
  - 响应: 200 OK + 更新后内容
  - 权限: 内容作者或管理员

- **POST /api/v1/contents/{id}/archive**
  - 请求体: reason (归档原因, 可选)
  - 将内容归档，不再公开显示
  - 响应: 200 OK + 更新后内容
  - 权限: 内容作者或管理员

#### 状态查询接口
- **GET /api/v1/contents/{id}/status-history**
  - 获取内容状态变更历史
  - 响应: 200 OK + 状态日志列表

- **GET /api/v1/contents/scheduled**
  - 获取当前用户的定时发布内容列表
  - 查询参数: page, page_size, sort_by
  - 响应: 200 OK + 定时内容列表

### 状态流转规则

#### 允许的状态转换
```python
STATE_TRANSITIONS = {
    'draft': ['pending_review', 'published', 'scheduled'],
    'pending_review': ['approved', 'rejected', 'draft'],
    'approved': ['published', 'scheduled'],
    'published': ['archived', 'draft'],
    'scheduled': ['published', 'draft', 'archived'],
    'archived': ['draft', 'published'],
    'rejected': ['draft']
}
```

#### 状态转换验证
```python
def validate_status_transition(current_status, target_status, user_role):
    """验证状态转换是否允许"""
    # 1. 检查状态转换是否在允许列表中
    if target_status not in STATE_TRANSITIONS.get(current_status, []):
        return False, "不允许的状态转换"

    # 2. 检查用户权限
    if target_status in ['approved', 'rejected'] and user_role != 'admin':
        return False, "仅管理员可以审核内容"

    return True, None
```

### 定时发布系统

#### Celery定时任务
```python
from celery import Celery
from datetime import datetime

@celery.task
def publish_scheduled_content(content_id):
    """定时发布任务"""
    try:
        content = ContentService.get_by_id(content_id)
        if content.status == 'scheduled' and content.scheduled_at <= datetime.now():
            ContentService.publish_content(content_id, system_user_id)
            logger.info(f"Content {content_id} published successfully")
        else:
            logger.warning(f"Content {content_id} not ready for publishing")
    except Exception as e:
        logger.error(f"Failed to publish content {content_id}: {str(e)}")
        # 重试机制或错误通知
```

#### 定时任务管理
```python
def schedule_content_publication(content_id, scheduled_at):
    """设置内容定时发布"""
    # 1. 更新内容状态
    ContentService.update_status(content_id, 'scheduled', scheduled_at=scheduled_at)

    # 2. 创建定时任务
    publish_scheduled_content.apply_async(
        args=[content_id],
        eta=scheduled_at
    )

    # 3. 记录状态变更
    log_status_change(content_id, 'draft', 'scheduled', user_id, 
                     f"设置定时发布: {scheduled_at}")
```

### 通知系统集成

#### 状态变更通知
```python
def notify_status_change(content_id, old_status, new_status, user_id):
    """状态变更通知"""
    content = ContentService.get_by_id(content_id)
    author = UserService.get_by_id(content.author_id)

    notifications = {
        'published': f"您的内容《{content.title}》已成功发布",
        'rejected': f"您的内容《{content.title}》审核未通过",
        'approved': f"您的内容《{content.title}》已通过审核",
        'archived': f"您的内容《{content.title}》已归档"
    }

    if new_status in notifications:
        NotificationService.send_notification(
            user_id=author.id,
            title='内容状态更新',
            message=notifications[new_status],
            type='content_status'
        )
```

## Dependencies

- [ ] Task 001: 后端基础架构
- [ ] Task 013: 内容核心CRUD系统
- [ ] Celery任务队列配置
- [ ] 通知系统 (可选)

## Effort Estimate

- Size: L
- Hours: 22小时
- Parallel: true

## Definition of Done

- [ ] 所有状态管理API接口实现完成
- [ ] 状态流转规则正确实现
- [ ] 定时发布功能正常工作
- [ ] 状态变更日志记录完整
- [ ] 权限控制验证通过
- [ ] 单元测试覆盖率达到90%
- [ ] 集成测试通过
- [ ] API文档更新完成

## Implementation Notes

### Service层设计
```python
class ContentStatusService:
    def change_status(self, content_id, new_status, user_id, reason=None):
        """变更内容状态"""
        pass

    def publish_content(self, content_id, user_id):
        """发布内容"""
        pass

    def schedule_content(self, content_id, scheduled_at, user_id):
        """定时发布内容"""
        pass

    def archive_content(self, content_id, user_id, reason=None):
        """归档内容"""
        pass

    def get_status_history(self, content_id):
        """获取状态历史"""
        pass
```

### 缓存策略
- `content:status:{id}`: 内容状态缓存 (TTL: 1小时)
- `content:scheduled:list`: 定时内容列表 (TTL: 30分钟)
- `content:draft:count:{user_id}`: 用户草稿数量 (TTL: 1小时)

### 错误处理
- 400: 状态转换参数无效
- 403: 无权限执行状态转换
- 409: 不允许的状态转换
- 422: 定时发布时间无效

### 安全考虑
- 状态转换权限严格验证
- 定时任务防重复执行
- 状态变更日志完整性
- 敏感操作审计日志