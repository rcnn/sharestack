---
name: Content Management Core
status: open
created: 2025-09-12T05:46:50Z
updated: 2025-09-12T05:46:50Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002]
parallel: false
conflicts_with: []
---

# Task 003: Content Management Core

## Overview

Implement the comprehensive content management system including rich text editor, multimedia support, version control, and publishing workflow. This is the core feature that enables creators to produce and manage high-quality content on the ShareStack platform.

## Context from PRD

According to the ShareStack PRD (sections 3.2, 4.1.1), the platform requires:

> **内容创作与编辑**:
> - Markdown编辑器与所见即所得编辑器
> - 图片上传和图床服务  
> - 视频上传和转码
> - 音频上传和播放器
> - 代码高亮和数学公式支持
> - 内容自动保存和版本历史

> **内容发布与管理**:
> - 内容分类和标签系统
> - 发布时间设置 (立即发布/定时发布)
> - 内容可见性设置 (公开/私密/订阅者)
> - 内容状态管理 (草稿/发布/归档)
> - SEO设置 (自定义URL、描述、关键词)

> **验收标准**:
> - [ ] 实现功能完整的Markdown编辑器
> - [ ] 支持拖拽上传图片、视频、音频
> - [ ] 自动生成多分辨率视频和图片
> - [ ] 实现内容自动保存和版本控制
> - [ ] 支持代码高亮和LaTeX数学公式

## Technical Specifications

### Rich Text Editor System
- **Dual Editor Support**: Markdown editor and WYSIWYG editor with seamless switching
- **Editor Framework**: Tiptap/ProseMirror-based editor with custom extensions
- **Real-time Collaboration**: Operational transforms for multi-user editing
- **Auto-save Mechanism**: Automatic draft saving every 30 seconds
- **Version History**: Git-like version control with diff visualization
- **Export Options**: Markdown, HTML, PDF export capabilities

### Media Asset Management
- **Multi-format Support**: Images (JPG, PNG, WebP, AVIF), Videos (MP4, WebM), Audio (MP3, AAC, OGG)
- **Cloud Storage Integration**: AWS S3 / Alibaba OSS with CDN distribution  
- **Automatic Optimization**: Image compression, format conversion, responsive sizing
- **Video Transcoding**: Multiple resolution generation (1080p, 720p, 480p, 360p)
- **Progressive Upload**: Chunked upload with resume capability for large files
- **Digital Watermarking**: Automatic watermark application for creator protection

### Content Organization System  
- **Hierarchical Categories**: Multi-level category system with inheritance
- **Tagging System**: Flexible tagging with auto-suggestions and trending tags
- **Content Collections**: Curated content groupings and series management
- **Search Optimization**: Full-text search with weighted relevance scoring
- **Content Relationships**: Related content suggestions and cross-references

### Publishing Workflow
- **Content States**: Draft → Review → Scheduled → Published → Archived lifecycle
- **Publishing Options**: Immediate, scheduled, or recurring publication
- **Visibility Controls**: Public, private, subscribers-only, premium-tier access
- **SEO Optimization**: Custom URLs, meta descriptions, Open Graph tags
- **Content Validation**: Automated quality checks and compliance scanning

## Acceptance Criteria

### Content Editor
- [ ] Markdown editor with live preview and syntax highlighting
- [ ] WYSIWYG editor with rich formatting options (bold, italic, headings, lists)
- [ ] Code block support with 20+ language syntax highlighting
- [ ] Mathematical formula rendering with LaTeX/MathJax support
- [ ] Table editing with column/row manipulation
- [ ] Embed support for YouTube, Vimeo, Bilibili videos
- [ ] Link preview generation with metadata extraction
- [ ] Auto-save functionality with visual save indicators

### Media Management
- [ ] Drag-and-drop file upload with progress indicators
- [ ] Image upload with automatic WebP/AVIF conversion
- [ ] Video upload with transcoding to multiple resolutions
- [ ] Audio upload with waveform visualization and player controls
- [ ] Media library with search, filtering, and organization
- [ ] Automatic thumbnail generation for videos and documents
- [ ] Digital watermark application with creator branding
- [ ] CDN integration for global fast delivery

### Version Control
- [ ] Automatic version snapshots on significant changes
- [ ] Visual diff comparison between versions
- [ ] Version restoration with confirmation workflow
- [ ] Version branching for experimental edits
- [ ] Collaboration history with author attribution
- [ ] Export version history as archive
- [ ] Conflict resolution for simultaneous edits

### Content Organization
- [ ] Category system with unlimited nesting levels
- [ ] Tag management with auto-complete suggestions
- [ ] Content series and collection creation
- [ ] Bulk content operations (tag, category, status changes)
- [ ] Content duplication and template system
- [ ] Advanced search with filters (date, category, tags, status)
- [ ] Content analytics integration (views, engagement metrics)

### Publishing & SEO
- [ ] Publishing workflow with draft/review/publish states
- [ ] Scheduled publishing with timezone support
- [ ] Custom URL slug generation with conflict detection
- [ ] Meta description and keyword optimization
- [ ] Open Graph and Twitter Card meta tags
- [ ] Sitemap generation and search engine submission
- [ ] Social media sharing optimization
- [ ] Content preview for different platforms (mobile, social)

## Technical Implementation Details

### Database Schema for Content System
```sql
-- Content core tables
CREATE TABLE contents (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    creator_id BIGINT NOT NULL,
    title VARCHAR(500) NOT NULL,
    slug VARCHAR(255) UNIQUE,
    content_type ENUM('article', 'video', 'audio', 'mixed') NOT NULL,
    status ENUM('draft', 'review', 'scheduled', 'published', 'archived') DEFAULT 'draft',
    visibility ENUM('public', 'private', 'subscribers', 'premium') DEFAULT 'public',
    content_data JSON NOT NULL, -- Editor content in structured format
    excerpt TEXT,
    featured_image VARCHAR(500),
    read_time INT, -- Estimated reading time in minutes
    published_at TIMESTAMP NULL,
    scheduled_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_creator_status (creator_id, status),
    INDEX idx_published_at (published_at DESC),
    INDEX idx_slug (slug),
    FULLTEXT idx_content_search (title, excerpt)
);

CREATE TABLE content_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    version_number INT NOT NULL,
    title VARCHAR(500) NOT NULL,
    content_data JSON NOT NULL,
    change_summary TEXT,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_content_version (content_id, version_number)
);

CREATE TABLE categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    parent_id BIGINT NULL,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) NOT NULL,
    description TEXT,
    sort_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL,
    UNIQUE KEY unique_slug (slug),
    INDEX idx_parent (parent_id, sort_order)
);

CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    slug VARCHAR(50) UNIQUE NOT NULL,
    usage_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_usage_count (usage_count DESC),
    INDEX idx_name (name)
);

CREATE TABLE content_categories (
    content_id BIGINT NOT NULL,
    category_id BIGINT NOT NULL,
    PRIMARY KEY (content_id, category_id),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
);

CREATE TABLE content_tags (
    content_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    PRIMARY KEY (content_id, tag_id),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);

CREATE TABLE media_assets (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    uploader_id BIGINT NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    media_type ENUM('image', 'video', 'audio', 'document') NOT NULL,
    processed_variants JSON, -- Different sizes/formats available
    metadata JSON, -- Width, height, duration, etc.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (uploader_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_uploader (uploader_id, created_at DESC),
    INDEX idx_media_type (media_type)
);
```

### Content Editor Data Structure (JSON)
```json
{
  "type": "doc",
  "content": [
    {
      "type": "heading",
      "attrs": { "level": 1 },
      "content": [{ "type": "text", "text": "文章标题" }]
    },
    {
      "type": "paragraph", 
      "content": [
        { "type": "text", "text": "这是一个包含" },
        { "type": "text", "marks": [{"type": "bold"}], "text": "粗体文本" },
        { "type": "text", "text": "的段落。" }
      ]
    },
    {
      "type": "codeBlock",
      "attrs": { "language": "javascript" },
      "content": [{ "type": "text", "text": "console.log('Hello World');" }]
    },
    {
      "type": "mediaEmbed",
      "attrs": {
        "src": "/api/media/12345/video.mp4",
        "type": "video",
        "caption": "演示视频",
        "width": 800,
        "height": 450
      }
    }
  ]
}
```

### Editor Component Architecture (Next.js)
```typescript
// Editor component with Tiptap integration
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import Image from '@tiptap/extension-image'
import CodeBlockLowlight from '@tiptap/extension-code-block-lowlight'
import Mathematics from '@tiptap/extension-mathematics'

export const ContentEditor = ({ content, onChange, autoSave = true }) => {
  const editor = useEditor({
    extensions: [
      StarterKit,
      Image.configure({
        HTMLAttributes: { class: 'responsive-image' }
      }),
      CodeBlockLowlight.configure({
        lowlight: createLowlight(common)
      }),
      Mathematics.configure({
        HTMLAttributes: { class: 'math-expression' }
      })
    ],
    content,
    onUpdate: ({ editor }) => {
      onChange?.(editor.getJSON())
      if (autoSave) {
        debouncedAutoSave(editor.getJSON())
      }
    }
  })

  return (
    <div className="editor-container">
      <EditorToolbar editor={editor} />
      <EditorContent editor={editor} className="prose max-w-none" />
      <MediaUploadZone onUpload={handleMediaUpload} />
    </div>
  )
}
```

## API Endpoints

### Content Management
```python
GET    /api/v1/contents                 # List contents (with filters)
POST   /api/v1/contents                 # Create new content
GET    /api/v1/contents/{id}            # Get content details
PUT    /api/v1/contents/{id}            # Update content
DELETE /api/v1/contents/{id}            # Delete content
POST   /api/v1/contents/{id}/publish    # Publish content
POST   /api/v1/contents/{id}/duplicate  # Duplicate content

# Version control
GET    /api/v1/contents/{id}/versions   # List content versions
GET    /api/v1/contents/{id}/versions/{version}  # Get specific version
POST   /api/v1/contents/{id}/restore/{version}  # Restore version

# Media management  
POST   /api/v1/media/upload             # Upload media file
GET    /api/v1/media                    # List user's media
GET    /api/v1/media/{id}               # Get media details
DELETE /api/v1/media/{id}               # Delete media file
```

### Content Organization
```python
GET    /api/v1/categories               # List categories (hierarchical)
POST   /api/v1/categories               # Create category
PUT    /api/v1/categories/{id}          # Update category
DELETE /api/v1/categories/{id}          # Delete category

GET    /api/v1/tags                     # List tags with usage stats
POST   /api/v1/tags                     # Create tag
GET    /api/v1/tags/suggestions?q=      # Tag suggestions
```

### Content Discovery
```python
GET    /api/v1/contents/search?q=       # Search contents
GET    /api/v1/contents/category/{slug} # Contents by category
GET    /api/v1/contents/tag/{slug}      # Contents by tag
GET    /api/v1/contents/related/{id}    # Related content suggestions
```

## Dependencies

### Infrastructure Requirements (Task 001)
- MySQL database for content storage with full-text search indexes
- Redis for caching frequently accessed content and user sessions
- Cloud storage (S3/OSS) for media file storage
- CDN configuration for global media delivery

### Authentication System (Task 002) 
- User authentication for creator identification
- Permission system for content access control
- Role-based access for admin features
- Session management for auto-save functionality

### External Service Dependencies
- **Cloud Storage**: AWS S3 or Alibaba Cloud OSS for media storage
- **CDN Service**: CloudFlare or AWS CloudFront for content delivery
- **Media Processing**: FFmpeg for video transcoding and image optimization
- **Search Service**: MySQL full-text search (Phase 1), optional Elasticsearch upgrade
- **Email Service**: For content publication notifications

## Effort Estimation
**Size**: Extra Large (XL)  
**Estimated Time**: 5-7 days  
**Complexity**: High - Complex editor integration and media processing pipeline

### Breakdown:
- Day 1-2: Database schema and basic content CRUD operations
- Day 3: Rich text editor integration with Tiptap/ProseMirror
- Day 4: Media upload and processing pipeline
- Day 5: Version control system implementation
- Day 6: Content organization (categories, tags, search)
- Day 7: Publishing workflow and SEO optimization features

## Risks and Mitigation

### Technical Risks
- **Editor Performance**: Large documents may cause browser performance issues
  - *Mitigation*: Virtualized rendering, lazy loading for media content
- **Media Processing Costs**: Video transcoding can be expensive at scale
  - *Mitigation*: Intelligent quality selection, user upload limits, cost monitoring
- **Data Loss Risk**: Complex editor state may not save properly
  - *Mitigation*: Frequent auto-save, local storage backup, version control safety net

### User Experience Risks
- **Learning Curve**: Advanced editor features may overwhelm new users
  - *Mitigation*: Progressive disclosure, guided onboarding, template system
- **Mobile Editing**: Rich editing on mobile devices is challenging
  - *Mitigation*: Responsive editor design, touch-optimized controls

### Scalability Risks
- **Search Performance**: Full-text search may slow down with large content volumes
  - *Mitigation*: Proper indexing strategy, search result caching, future Elasticsearch migration path
- **Storage Costs**: Media storage costs grow with user adoption
  - *Mitigation*: Intelligent archiving, compression, user storage quotas

## Success Metrics
- Content creation completion rate > 85% (users who start creating content)
- Auto-save success rate > 99.9% (no data loss incidents)
- Media upload success rate > 95% for files under 100MB
- Editor performance: Page interactions under 100ms response time
- Search relevance: User click-through rate on search results > 40%
- Version control usage: 30% of creators use version history features

## Deliverables
1. **Content Database Schema** - Complete content management tables with indexes
2. **Rich Text Editor** - Tiptap-based editor with markdown and WYSIWYG modes
3. **Media Management System** - Upload, processing, and delivery pipeline
4. **Version Control System** - Content versioning with diff and restore capabilities
5. **Content Organization** - Categories, tags, and search functionality
6. **Publishing Workflow** - Draft-to-publish lifecycle with scheduling
7. **Content APIs** - RESTful endpoints for all content operations
8. **SEO Optimization** - Meta tags, sitemaps, and search engine features
9. **Admin Interface** - Content moderation and management tools
10. **Documentation** - Creator guide and API documentation

This content management system serves as the creative foundation of ShareStack, empowering creators to produce professional-quality content while providing readers with an excellent consumption experience.