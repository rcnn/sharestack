---
name: 私信系统
status: open
created: 2025-09-15T03:00:00Z
updated: 2025-09-15T04:58:15Z
github: https://github.com/rcnn/sharestack/issues/75
depends_on: [002]
parallel: true
conflicts_with: []
---

# Task: 私信系统

## Description
实现ShareStack平台私信功能，支持用户之间的私人消息通信，包括发送私信、接收私信、会话管理和消息状态管理。提供安全、高效的用户沟通渠道。

## Acceptance Criteria
- [ ] 实现发送私信API接口 (`POST /api/v1/messages/send`)
- [ ] 实现接收私信API接口 (`GET /api/v1/messages/receive`)
- [ ] 实现会话管理API接口 (`GET /api/v1/messages/conversations`)
- [ ] 实现私信状态管理功能
- [ ] 支持多媒体消息类型（文本、图片、文件）
- [ ] 实现消息加密和隐私保护
- [ ] 完成私信系统的完整测试

## Technical Details

### API 接口规范
- **发送私信** (`POST /api/v1/messages/send`)
  - 支持发送文本、图片、文件消息
  - 消息内容安全检查和过滤
  - 用户黑名单和屏蔽检查
  - 消息发送限制和防骚扰
  - 消息加密存储

- **接收私信** (`GET /api/v1/messages/receive`)
  - 获取用户收到的私信
  - 支持分页和实时更新
  - 消息状态标记（已读/未读）
  - 消息筛选和搜索
  - 支持消息撤回和删除

- **会话管理** (`GET /api/v1/messages/conversations`)
  - 获取用户所有会话列表
  - 按最后消息时间排序
  - 显示未读消息数量
  - 会话置顶和删除
  - 会话搜索和筛选

### 数据模型设计
```sql
-- 会话表
conversations:
- id (主键)
- participant_1 (参与者1用户ID)
- participant_2 (参与者2用户ID)
- last_message_id (最后一条消息ID)
- last_message_time (最后消息时间)
- is_deleted_by_1 (用户1是否删除)
- is_deleted_by_2 (用户2是否删除)
- created_at (创建时间)

-- 消息表
messages:
- id (主键)
- conversation_id (会话ID)
- sender_id (发送者ID)
- receiver_id (接收者ID)
- message_type (消息类型: text, image, file)
- content (消息内容，加密存储)
- file_url (文件URL，如果是文件消息)
- status (消息状态: sent, delivered, read)
- is_recalled (是否撤回)
- created_at (发送时间)

-- 消息状态表
message_status:
- message_id (消息ID)
- user_id (用户ID)
- status (状态: delivered, read)
- timestamp (状态更新时间)
```

### 消息类型支持
```yaml
消息类型:
  文本消息:
    - 纯文本内容
    - 表情符号支持
    - @提及功能
    - 链接预览

  图片消息:
    - 图片上传和压缩
    - 缩略图生成
    - 图片水印添加
    - 图片安全检查

  文件消息:
    - 文件上传和下载
    - 文件类型限制
    - 文件大小限制
    - 病毒扫描检查

  系统消息:
    - 系统通知
    - 好友请求
    - 群聊邀请
```

### 安全和隐私保护
- **消息加密**：端到端加密保护用户隐私
- **内容过滤**：敏感词检测和内容审核
- **防骚扰机制**：频率限制和黑名单功能
- **消息撤回**：发送后限时撤回功能
- **阅后即焚**：支持定时销毁消息

### 消息状态管理
```yaml
消息状态流转:
  - sent: 消息已发送
  - delivered: 消息已送达
  - read: 消息已读
  - recalled: 消息已撤回

状态更新机制:
  - WebSocket实时推送
  - 离线消息存储
  - 消息送达确认
  - 已读回执功能
```

### 性能优化策略
- **分库分表**：按用户ID分片存储
- **消息归档**：历史消息定期归档
- **缓存机制**：热点会话Redis缓存
- **CDN加速**：文件消息CDN分发
- **消息预加载**：智能预加载机制

### 防骚扰机制
```yaml
防骚扰功能:
  - 消息频率限制: 每分钟最多发送10条
  - 黑名单功能: 屏蔽指定用户消息
  - 关键词过滤: 自动过滤敏感内容
  - 举报系统: 用户可举报骚扰消息
  - 管理员干预: 人工审核和处理
```

## Dependencies
- [ ] 依赖任务002：用户认证系统
- [ ] 依赖文件存储系统
- [ ] 依赖WebSocket服务
- [ ] 依赖消息队列系统
- [ ] 依赖内容安全服务

## Effort Estimate
- Size: L
- Hours: 18-22
- Parallel: true

## Definition of Done
- [ ] 私信功能完全实现并测试通过
- [ ] 多媒体消息类型支持完善
- [ ] 安全和隐私保护机制有效
- [ ] 防骚扰功能工作正常
- [ ] 实时消息推送稳定
- [ ] API接口符合设计规范
- [ ] 单元测试覆盖率达到90%
- [ ] 消息送达率和实时性达标