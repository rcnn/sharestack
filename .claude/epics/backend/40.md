---
name: 内容权限管理
status: backlog
created: 2025-09-15T02:51:00Z
github: https://github.com/rcnn/sharestack/issues/40
depends_on: [001, 34]
parallel: true
conflicts_with: []
---

# Task: 内容权限管理

## Description

实现内容的精细化权限管理系统，包括访问权限、付费内容保护、权限验证中间件等。支持灵活的权限配置和安全的内容保护。

## Acceptance Criteria

- [ ] 完成访问权限API (/api/v1/contents/{id}/permissions)
- [ ] 完成权限控制API (/api/v1/contents/{id}/access-control)
- [ ] 实现付费内容保护机制
- [ ] 实现权限验证中间件
- [ ] 实现权限继承和组合
- [ ] 实现权限缓存机制
- [ ] 实现权限审计日志
- [ ] 编写完整的测试用例

## Technical Details

### 权限数据模型设计

#### Content_Permissions权限表
```sql
CREATE TABLE content_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    permission_type ENUM('view', 'comment', 'share', 'download', 'edit', 'delete') NOT NULL,
    access_level ENUM('public', 'authenticated', 'subscribed', 'premium', 'private', 'custom') NOT NULL,
    required_role ENUM('user', 'author', 'moderator', 'admin') DEFAULT 'user',
    price DECIMAL(10,2) DEFAULT 0.00, -- 付费内容价格
    access_duration INT DEFAULT 0, -- 访问时限(天), 0表示永久
    start_date TIMESTAMP NULL, -- 生效时间
    end_date TIMESTAMP NULL, -- 失效时间
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_content_permission (content_id, permission_type),
    INDEX idx_access_level (access_level),
    INDEX idx_price (price),
    UNIQUE KEY unique_content_permission (content_id, permission_type),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

#### User_Content_Access用户访问记录表
```sql
CREATE TABLE user_content_access (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    content_id BIGINT NOT NULL,
    permission_type ENUM('view', 'comment', 'share', 'download', 'edit', 'delete') NOT NULL,
    access_granted BOOLEAN DEFAULT TRUE,
    access_source ENUM('free', 'purchased', 'subscription', 'granted', 'author') NOT NULL,
    purchase_id BIGINT NULL, -- 购买记录ID
    granted_by BIGINT NULL, -- 授权者
    expires_at TIMESTAMP NULL, -- 访问过期时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_content (user_id, content_id),
    INDEX idx_permission_type (permission_type),
    INDEX idx_expires_at (expires_at),
    INDEX idx_access_source (access_source),
    UNIQUE KEY unique_user_content_permission (user_id, content_id, permission_type),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id)
);
```

#### Permission_Groups权限组表
```sql
CREATE TABLE permission_groups (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    permissions JSON NOT NULL, -- 权限配置
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_name (name),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### API接口规范

#### 权限管理接口
- **GET /api/v1/contents/{id}/permissions**
  - 获取内容的所有权限设置
  - 响应: 200 OK + 权限配置列表
  - 权限: 内容作者或管理员

- **PUT /api/v1/contents/{id}/permissions**
  - 请求体: permission_type, access_level, price, access_duration
  - 更新内容权限设置
  - 响应: 200 OK + 更新后权限
  - 权限: 内容作者或管理员

#### 访问控制接口
- **POST /api/v1/contents/{id}/access-control**
  - 请求体: user_id, permission_type, access_duration, reason
  - 手动授予用户访问权限
  - 响应: 201 Created + 授权记录
  - 权限: 内容作者或管理员

- **DELETE /api/v1/contents/{id}/access-control/{user_id}**
  - 撤销用户的访问权限
  - 查询参数: permission_type
  - 响应: 204 No Content
  - 权限: 内容作者或管理员

#### 权限检查接口
- **GET /api/v1/contents/{id}/check-access**
  - 查询参数: permission_type, user_id (可选)
  - 检查当前用户对内容的访问权限
  - 响应: 200 OK + 权限检查结果
  - 权限: 公开接口

### 权限验证系统

#### 权限验证中间件
```python
from functools import wraps
from flask import request, jsonify, g

def require_content_permission(permission_type):
    """内容权限验证装饰器"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            content_id = kwargs.get('content_id') or request.view_args.get('id')
            user_id = g.current_user.id if g.current_user else None

            # 权限检查
            has_permission, reason = ContentPermissionService.check_permission(
                user_id, content_id, permission_type
            )

            if not has_permission:
                return jsonify({
                    'error': 'Access denied',
                    'reason': reason,
                    'required_permission': permission_type
                }), 403

            # 记录访问日志
            ContentAccessLogService.log_access(
                user_id, content_id, permission_type, 'granted'
            )

            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

#### 权限检查服务
```python
class ContentPermissionService:
    @staticmethod
    def check_permission(user_id, content_id, permission_type):
        """检查用户是否有权访问内容"""
        # 1. 检查基本权限
        basic_check = check_basic_permission(user_id, content_id, permission_type)
        if not basic_check['allowed']:
            return False, basic_check['reason']

        # 2. 检查付费内容权限
        if basic_check['requires_payment']:
            payment_check = check_payment_permission(user_id, content_id)
            if not payment_check['allowed']:
                return False, payment_check['reason']

        # 3. 检查时间限制
        time_check = check_time_restriction(user_id, content_id, permission_type)
        if not time_check['allowed']:
            return False, time_check['reason']

        # 4. 检查特殊规则
        special_check = check_special_rules(user_id, content_id, permission_type)
        if not special_check['allowed']:
            return False, special_check['reason']

        return True, None

    @staticmethod
    def check_basic_permission(user_id, content_id, permission_type):
        """检查基本权限"""
        content = ContentRepository.get_by_id(content_id)
        if not content:
            return {'allowed': False, 'reason': '内容不存在'}

        # 作者始终有所有权限
        if user_id == content.author_id:
            return {'allowed': True, 'requires_payment': False}

        # 管理员有所有权限
        if UserService.is_admin(user_id):
            return {'allowed': True, 'requires_payment': False}

        # 获取内容权限设置
        permission = ContentPermissionRepository.get_permission(
            content_id, permission_type
        )

        if not permission:
            # 默认权限设置
            return get_default_permission(content, permission_type)

        # 根据访问级别检查
        return check_access_level(user_id, permission)
```

### 付费内容保护

#### 付费验证服务
```python
class PaymentPermissionService:
    @staticmethod
    def check_payment_permission(user_id, content_id):
        """检查付费内容权限"""
        # 1. 检查是否已购买
        purchase = PurchaseRepository.get_user_purchase(user_id, content_id)
        if purchase and purchase.status == 'completed':
            return {'allowed': True, 'source': 'purchase'}

        # 2. 检查订阅权限
        subscription = SubscriptionService.get_active_subscription(user_id)
        if subscription and content_covered_by_subscription(content_id, subscription):
            return {'allowed': True, 'source': 'subscription'}

        # 3. 检查手动授权
        manual_access = UserContentAccessRepository.get_access(
            user_id, content_id, 'view'
        )
        if manual_access and manual_access.access_granted:
            if not manual_access.expires_at or manual_access.expires_at > datetime.now():
                return {'allowed': True, 'source': 'granted'}

        return {'allowed': False, 'reason': '需要购买或订阅'}
```

#### 内容加密保护
```python
class ContentProtectionService:
    @staticmethod
    def get_protected_content(content_id, user_id, permission_type='view'):
        """获取受保护的内容"""
        # 权限检查
        has_permission, reason = ContentPermissionService.check_permission(
            user_id, content_id, permission_type
        )

        if not has_permission:
            return {
                'error': 'Access denied',
                'reason': reason,
                'preview': get_content_preview(content_id)
            }

        # 获取完整内容
        content = ContentRepository.get_by_id(content_id)

        # 对敏感内容进行加密保护
        if content.is_sensitive:
            content = decrypt_sensitive_content(content, user_id)

        # 水印保护
        if content.is_paid:
            content = add_watermark(content, user_id)

        return {'content': content, 'access_granted': True}
```

### 权限缓存系统

#### 权限缓存策略
```python
class PermissionCacheService:
    @staticmethod
    def get_cached_permission(user_id, content_id, permission_type):
        """获取缓存的权限结果"""
        cache_key = f"permission:{user_id}:{content_id}:{permission_type}"
        return redis_client.get(cache_key)

    @staticmethod
    def cache_permission(user_id, content_id, permission_type, result, ttl=300):
        """缓存权限检查结果"""
        cache_key = f"permission:{user_id}:{content_id}:{permission_type}"
        redis_client.setex(cache_key, ttl, json.dumps(result))

    @staticmethod
    def invalidate_permission_cache(user_id=None, content_id=None):
        """失效权限缓存"""
        if user_id and content_id:
            pattern = f"permission:{user_id}:{content_id}:*"
        elif user_id:
            pattern = f"permission:{user_id}:*"
        elif content_id:
            pattern = f"permission:*:{content_id}:*"
        else:
            pattern = "permission:*"

        keys = redis_client.keys(pattern)
        if keys:
            redis_client.delete(*keys)
```

## Dependencies

- [ ] Task 001: 后端基础架构
- [ ] Task 013: 内容核心CRUD系统
- [ ] 用户管理模块 (角色权限)
- [ ] 支付系统 (付费内容)
- [ ] 订阅系统 (订阅权限)

## Effort Estimate

- Size: XL
- Hours: 32小时
- Parallel: true

## Definition of Done

- [ ] 所有权限管理API接口实现完成
- [ ] 权限验证中间件正常工作
- [ ] 付费内容保护机制有效
- [ ] 权限缓存系统正常
- [ ] 权限检查性能满足要求 (<50ms)
- [ ] 安全测试通过
- [ ] 单元测试覆盖率达到90%
- [ ] API文档更新完成

## Implementation Notes

### Service层设计
```python
class ContentPermissionService:
    def check_permission(self, user_id, content_id, permission_type):
        """检查权限"""
        pass

    def grant_permission(self, content_id, user_id, permission_type, duration=None):
        """授予权限"""
        pass

    def revoke_permission(self, content_id, user_id, permission_type):
        """撤销权限"""
        pass

    def update_content_permissions(self, content_id, permissions, user_id):
        """更新内容权限"""
        pass
```

### 缓存键设计
- `permission:{user_id}:{content_id}:{type}`: 权限检查结果
- `content:permissions:{id}`: 内容权限配置
- `user:access:{user_id}`: 用户访问权限列表

### 安全考虑
- 权限提升攻击防护
- 数据访问日志记录
- 敏感操作二次验证
- 权限变更通知机制

### 错误处理
- 403: 权限不足
- 402: 需要付费
- 423: 内容被锁定
- 429: 访问频率过高