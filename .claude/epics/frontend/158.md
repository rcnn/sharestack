# 任务003 - 路由和布局系统

## 任务信息
```yaml
id: frontend-158
title: 路由和布局系统
epic: frontend
category: architecture
priority: high
status: pending
assigned_to: TBD
estimated_hours: 24
actual_hours: 0
created_date: 2025-09-22T05:10:33Z
updated_date: 2025-09-22T05:10:33Z
depends_on: [156]
parallel: true
sprint: 1
```

## 描述

基于Next.js 14+ App Router构建ShareStack前端的路由系统和页面布局架构。设计灵活、可扩展的路由结构，实现统一的页面布局管理，为用户提供流畅的导航体验和一致的界面风格。

## 验收标准

1. **App Router配置完成**
   - 建立清晰的路由目录结构
   - 配置动态路由和嵌套路由
   - 实现路由中间件和访问控制
   - 设置路由加载状态和错误处理

2. **页面布局系统**
   - 创建主布局组件（RootLayout）
   - 实现响应式导航栏和侧边栏
   - 设计页面头部和底部组件
   - 建立内容区域布局规范

3. **导航组件开发**
   - 主导航菜单组件
   - 面包屑导航组件
   - 移动端导航抽屉
   - 用户账户导航区域

4. **路由状态管理**
   - 实现路由状态持久化
   - 配置页面访问权限控制
   - 建立路由跳转和回退机制
   - 设置路由参数管理

5. **性能优化配置**
   - 配置路由级代码分割
   - 实现页面预加载和缓存
   - 设置路由懒加载机制
   - 优化首屏加载性能

## 技术实现要点

### 1. 路由目录结构
```
src/app/
├── (auth)/                 # 认证路由组
│   ├── login/
│   │   └── page.tsx
│   ├── register/
│   │   └── page.tsx
│   └── layout.tsx
├── (main)/                 # 主应用路由组
│   ├── dashboard/
│   │   ├── page.tsx
│   │   └── loading.tsx
│   ├── content/
│   │   ├── page.tsx
│   │   ├── [id]/
│   │   │   └── page.tsx
│   │   └── create/
│   │       └── page.tsx
│   ├── profile/
│   │   ├── page.tsx
│   │   └── settings/
│   │       └── page.tsx
│   └── layout.tsx
├── globals.css
├── layout.tsx              # 根布局
├── page.tsx               # 首页
├── loading.tsx            # 全局加载页面
├── error.tsx              # 全局错误页面
└── not-found.tsx          # 404页面
```

### 2. 根布局组件
```typescript
// src/app/layout.tsx
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import { Providers } from '@/components/providers'
import { Toaster } from '@/components/ui/toaster'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'ShareStack - 知识付费平台',
  description: '专业的中文知识付费和内容创作平台',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN" className="h-full">
      <body className={`${inter.className} h-full`}>
        <Providers>
          {children}
          <Toaster />
        </Providers>
      </body>
    </html>
  )
}
```

### 3. 主应用布局
```typescript
// src/app/(main)/layout.tsx
import { Header } from '@/components/layout/header'
import { Sidebar } from '@/components/layout/sidebar'
import { Footer } from '@/components/layout/footer'

export default function MainLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <div className="flex flex-1">
        <Sidebar className="hidden lg:flex" />
        <main className="flex-1 p-6">
          {children}
        </main>
      </div>
      <Footer />
    </div>
  )
}
```

### 4. 导航组件架构
```typescript
// src/components/layout/header.tsx
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet'
import { Menu, Search, User } from 'lucide-react'
import { Navigation } from './navigation'
import { UserMenu } from './user-menu'

export function Header() {
  const [isOpen, setIsOpen] = useState(false)

  return (
    <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container flex h-16 items-center justify-between">
        {/* Logo */}
        <Link href="/" className="flex items-center space-x-2">
          <span className="text-xl font-bold">ShareStack</span>
        </Link>

        {/* Desktop Navigation */}
        <Navigation className="hidden md:flex" />

        {/* Actions */}
        <div className="flex items-center space-x-4">
          <Button variant="ghost" size="icon">
            <Search className="h-4 w-4" />
          </Button>
          <UserMenu />

          {/* Mobile Menu */}
          <Sheet open={isOpen} onOpenChange={setIsOpen}>
            <SheetTrigger asChild className="md:hidden">
              <Button variant="ghost" size="icon">
                <Menu className="h-4 w-4" />
              </Button>
            </SheetTrigger>
            <SheetContent side="left">
              <Navigation vertical onNavigate={() => setIsOpen(false)} />
            </SheetContent>
          </Sheet>
        </div>
      </div>
    </header>
  )
}
```

### 5. 路由中间件配置
```typescript
// src/middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl

  // 检查认证状态
  const token = request.cookies.get('auth-token')

  // 保护需要认证的路由
  const protectedRoutes = ['/dashboard', '/profile', '/content/create']
  const isProtectedRoute = protectedRoutes.some(route =>
    pathname.startsWith(route)
  )

  if (isProtectedRoute && !token) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // 已登录用户访问认证页面时重定向
  if (pathname.startsWith('/login') && token) {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
}
```

### 6. 路由状态管理
```typescript
// src/store/navigation.ts
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface NavigationState {
  currentPath: string
  previousPath: string
  breadcrumbs: Array<{ label: string; href: string }>
  setCurrentPath: (path: string) => void
  setBreadcrumbs: (breadcrumbs: Array<{ label: string; href: string }>) => void
  goBack: () => void
}

export const useNavigationStore = create<NavigationState>()(
  persist(
    (set, get) => ({
      currentPath: '/',
      previousPath: '/',
      breadcrumbs: [],

      setCurrentPath: (path) => set((state) => ({
        previousPath: state.currentPath,
        currentPath: path,
      })),

      setBreadcrumbs: (breadcrumbs) => set({ breadcrumbs }),

      goBack: () => {
        const { previousPath } = get()
        window.history.back()
      },
    }),
    {
      name: 'navigation-storage',
    }
  )
)
```

## Definition of Done

- [ ] App Router目录结构完整建立，路由访问正常
- [ ] 主布局组件完成，支持响应式设计
- [ ] 导航组件开发完成，包含桌面端和移动端适配
- [ ] 路由中间件配置完成，访问权限控制正常
- [ ] 面包屑导航功能实现，用户导航体验良好
- [ ] 路由加载状态和错误页面配置完成
- [ ] 动态路由和嵌套路由功能验证通过
- [ ] 路由级代码分割配置完成，性能优化到位
- [ ] 移动端导航抽屉功能正常，用户体验流畅
- [ ] 所有布局组件包含TypeScript类型定义

## 注意事项

1. 确保路由结构设计具有良好的扩展性
2. 重视移动端用户体验，优化触屏操作
3. 合理设置路由缓存策略，平衡性能和数据实时性
4. 建立清晰的路由命名规范，便于维护
5. 预留国际化路由的扩展空间

## 相关资源

- [Next.js App Router官方文档](https://nextjs.org/docs/app)
- [Next.js路由中间件](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [React Navigation最佳实践](https://reactnavigation.org/)
- [Web无障碍导航设计](https://www.w3.org/WAI/ARIA/apg/)
