---
name: 标签系统实现
status: backlog
created: 2025-09-15T02:51:00Z
github: https://github.com/rcnn/sharestack/issues/37
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: 标签系统实现

## Description

实现内容标签管理功能，包括标签的创建、管理、内容标签关联，以及标签推荐和统计功能。支持标签搜索、热门标签和智能标签建议。

## Acceptance Criteria

- [ ] 完成标签列表API (/api/v1/tags/list)
- [ ] 完成标签创建API (/api/v1/tags/create)
- [ ] 完成标签搜索API (/api/v1/tags/search)
- [ ] 完成内容标签管理API (/api/v1/contents/{id}/tags)
- [ ] 完成添加标签API (/api/v1/contents/{id}/add-tag)
- [ ] 实现标签推荐功能
- [ ] 实现标签统计和热门标签
- [ ] 编写完整的测试用例

## Technical Details

### 标签数据模型设计

#### Tags表结构
```sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(200),
    color VARCHAR(7) DEFAULT '#999999', -- 标签颜色 (hex)
    usage_count INT DEFAULT 0, -- 使用次数
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_name (name),
    INDEX idx_usage_count (usage_count),
    INDEX idx_created_by (created_by),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

#### Content_Tags关联表
```sql
CREATE TABLE content_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_content_tag (content_id, tag_id),
    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

### API接口规范

#### 标签管理接口
- **GET /api/v1/tags/list**
  - 查询参数:
    - page, page_size: 分页参数
    - sort_by: 排序 (name, usage_count, created_at)
    - popular: 是否只返回热门标签
  - 响应: 200 OK + 标签列表
  - 权限: 公开接口

- **POST /api/v1/tags/create**
  - 请求体: name, description, color
  - 响应: 201 Created + 标签详情
  - 权限: 认证用户
  - 业务规则: 自动去重，标签名转小写

- **GET /api/v1/tags/search**
  - 查询参数: q (搜索关键词), limit (默认10)
  - 支持前缀匹配和模糊搜索
  - 响应: 200 OK + 匹配标签列表
  - 权限: 公开接口

#### 内容标签关联接口
- **GET /api/v1/contents/{id}/tags**
  - 获取内容的所有标签
  - 响应: 200 OK + 标签列表

- **POST /api/v1/contents/{id}/tags**
  - 请求体: tag_ids (数组) 或 tag_names (数组)
  - 批量为内容添加标签，不存在的标签自动创建
  - 响应: 201 Created + 添加的标签列表

- **POST /api/v1/contents/{id}/add-tag**
  - 请求体: tag_name 或 tag_id
  - 为内容添加单个标签
  - 响应: 201 Created + 标签详情

- **DELETE /api/v1/contents/{id}/tags/{tag_id}**
  - 移除内容的指定标签
  - 响应: 204 No Content

### 标签推荐系统

#### 基于内容的标签推荐
```python
def suggest_tags_for_content(content_text, content_type):
    """基于内容文本推荐标签"""
    # 1. 关键词提取
    keywords = extract_keywords(content_text)

    # 2. 匹配已有标签
    suggested_tags = []
    for keyword in keywords:
        matching_tags = search_tags(keyword)
        suggested_tags.extend(matching_tags)

    # 3. 智能标签生成
    if len(suggested_tags) < 3:
        generated_tags = generate_tags_from_content(content_text)
        suggested_tags.extend(generated_tags)

    return suggested_tags[:10]  # 最多返回10个建议
```

#### 基于用户行为的标签推荐
```python
def suggest_tags_for_user(user_id):
    """基于用户历史行为推荐标签"""
    # 1. 获取用户常用标签
    user_tags = get_user_frequent_tags(user_id)

    # 2. 获取相似用户的标签
    similar_user_tags = get_similar_users_tags(user_id)

    # 3. 获取热门标签
    trending_tags = get_trending_tags()

    return merge_and_rank_suggestions(user_tags, similar_user_tags, trending_tags)
```

### 标签统计功能

#### 热门标签统计
- 按使用次数排序的热门标签
- 按时间范围的标签趋势
- 标签共现统计 (经常一起使用的标签)

#### 标签分析API
- **GET /api/v1/tags/popular**
  - 查询参数: period (day, week, month), limit (默认20)
  - 响应: 热门标签列表

- **GET /api/v1/tags/trending**
  - 查询参数: period, limit
  - 响应: 趋势标签列表 (增长最快的标签)

- **GET /api/v1/tags/{id}/related**
  - 获取相关标签 (经常一起使用的标签)
  - 响应: 相关标签列表

### 性能优化

#### 索引优化
```sql
-- 标签搜索优化
CREATE INDEX idx_tag_name_prefix ON tags(name(10));
-- 标签使用统计优化
CREATE INDEX idx_content_tags_lookup ON content_tags(tag_id, content_id);
-- 内容标签查询优化
CREATE INDEX idx_content_tags_content ON content_tags(content_id, tag_id);
```

#### 缓存策略
- `tags:popular:{period}`: 热门标签缓存 (TTL: 1小时)
- `tags:trending:{period}`: 趋势标签缓存 (TTL: 30分钟)
- `content:tags:{id}`: 内容标签缓存 (TTL: 1小时)
- `tag:suggestions:{hash}`: 标签推荐缓存 (TTL: 15分钟)

## Dependencies

- [ ] Task 001: 后端基础架构
- [ ] 内容管理模块 (标签关联)
- [ ] 用户管理模块 (创建者权限)

## Effort Estimate

- Size: M
- Hours: 16小时
- Parallel: true

## Definition of Done

- [ ] 所有标签管理API接口实现完成
- [ ] 标签推荐算法正常工作
- [ ] 标签统计功能准确
- [ ] 内容标签关联功能正常
- [ ] 标签搜索性能满足要求 (<100ms)
- [ ] 单元测试覆盖率达到90%
- [ ] API文档更新完成
- [ ] 性能测试通过

## Implementation Notes

### Service层设计
```python
class TagService:
    def create_tag(self, tag_data, user_id):
        """创建标签"""
        pass

    def search_tags(self, query, limit=10):
        """搜索标签"""
        pass

    def suggest_tags_for_content(self, content_text, content_type):
        """内容标签推荐"""
        pass

    def get_popular_tags(self, period='week', limit=20):
        """获取热门标签"""
        pass

    def assign_tags_to_content(self, content_id, tags, user_id):
        """为内容分配标签"""
        pass

    def update_tag_usage_count(self, tag_id, delta=1):
        """更新标签使用次数"""
        pass
```

### 业务规则
1. **标签命名规范**: 2-20个字符，支持中英文、数字、下划线
2. **标签去重**: 自动转换为小写，去除前后空格
3. **使用限制**: 每个内容最多20个标签
4. **权限控制**: 用户只能删除自己创建的标签
5. **自动清理**: 定期清理未使用的标签 (usage_count = 0)

### 错误处理
- 400: 标签名称格式无效
- 409: 标签名称已存在
- 422: 标签数量超出限制
- 429: 标签操作频率限制

### 扩展功能
- 标签别名和同义词支持
- 标签层级关系 (父子标签)
- 标签推荐机器学习模型集成
- 标签可视化分析和词云展示