---
name: 内容列表和搜索系统
status: backlog
created: 2025-09-15T02:51:00Z
github: https://github.com/rcnn/sharestack/issues/35
depends_on: [001, 34]
parallel: true
conflicts_with: []
---

# Task: 内容列表和搜索系统

## Description

实现内容的列表展示、分页、排序和全文搜索功能，包括多种过滤条件和高级搜索选项。为用户提供快速准确的内容发现体验。

## Acceptance Criteria

- [ ] 完成内容列表API (/api/v1/contents/list)
- [ ] 完成全文搜索API (/api/v1/contents/search)
- [ ] 完成内容过滤API (/api/v1/contents/filter)
- [ ] 实现分页和排序功能
- [ ] 支持多种搜索条件组合
- [ ] 实现搜索结果高亮
- [ ] 添加搜索性能优化
- [ ] 编写完整的测试用例

## Technical Details

### API接口规范

#### 内容列表接口
- **GET /api/v1/contents/list**
- 查询参数:
  - page: 页码 (默认1)
  - page_size: 每页数量 (默认20, 最大100)
  - sort_by: 排序字段 (created_at, updated_at, title, view_count)
  - sort_order: 排序方向 (asc, desc, 默认desc)
  - status: 内容状态过滤 (draft, published, archived)
  - content_type: 内容类型过滤
  - author_id: 作者过滤
  - is_paid: 付费内容过滤
- 响应: 200 OK + 分页内容列表

#### 全文搜索接口
- **GET /api/v1/contents/search**
- 查询参数:
  - q: 搜索关键词 (必填)
  - page, page_size: 分页参数
  - content_type: 内容类型过滤
  - author_id: 作者过滤
  - date_range: 时间范围过滤
  - sort_relevance: 按相关性排序 (默认true)
- 响应: 200 OK + 搜索结果 (含高亮)

#### 高级过滤接口
- **POST /api/v1/contents/filter**
- 请求体:
  - filters: 过滤条件对象
  - search_text: 文本搜索
  - price_range: 价格区间
  - tag_ids: 标签ID列表
  - category_ids: 分类ID列表
  - date_created: 创建时间范围
- 响应: 200 OK + 过滤结果

### 搜索技术实现

#### MySQL全文搜索
```sql
-- 为内容表添加全文索引
ALTER TABLE contents ADD FULLTEXT(title, content, summary);

-- 搜索查询示例
SELECT *, MATCH(title, content, summary) AGAINST('搜索关键词' IN NATURAL LANGUAGE MODE) as relevance_score
FROM contents
WHERE MATCH(title, content, summary) AGAINST('搜索关键词' IN NATURAL LANGUAGE MODE)
ORDER BY relevance_score DESC;
```

#### 分页优化
- 使用游标分页避免深度分页性能问题
- 实现基于ID的分页策略
- 添加总数缓存机制

#### 搜索结果高亮
- 服务端实现关键词高亮
- 支持HTML标签包装高亮内容
- 摘要截取和关键词上下文

### 性能优化策略

#### 索引优化
```sql
-- 复合索引优化常见查询
CREATE INDEX idx_content_search ON contents(status, content_type, created_at);
CREATE INDEX idx_author_status ON contents(author_id, status);
CREATE INDEX idx_paid_type ON contents(is_paid, content_type);
```

#### 缓存策略
- Redis缓存热门搜索结果 (TTL: 15分钟)
- 缓存分页总数 (TTL: 5分钟)
- 缓存热门关键词和搜索建议

#### 搜索分析
- 记录搜索关键词和结果数
- 统计搜索点击率
- 提供搜索建议和补全

## Dependencies

- [ ] Task 001: 后端基础架构
- [ ] Task 013: 内容核心CRUD系统
- [ ] MySQL全文搜索功能配置
- [ ] Redis缓存系统配置

## Effort Estimate

- Size: L
- Hours: 20小时
- Parallel: true

## Definition of Done

- [ ] 所有搜索和列表API接口实现完成
- [ ] 全文搜索功能正常工作
- [ ] 分页和排序功能验证通过
- [ ] 搜索性能满足要求 (<200ms)
- [ ] 单元测试和集成测试通过
- [ ] API文档更新完成
- [ ] 性能测试通过

## Implementation Notes

### Service层设计
```python
class ContentSearchService:
    def list_contents(self, filters, pagination, sorting):
        """内容列表查询"""
        pass

    def search_contents(self, query, filters, pagination):
        """全文搜索"""
        pass

    def filter_contents(self, complex_filters):
        """高级过滤"""
        pass

    def highlight_results(self, content, keywords):
        """搜索结果高亮"""
        pass
```

### 缓存键设计
- `content:list:{hash}`: 列表查询缓存
- `content:search:{hash}`: 搜索结果缓存
- `content:count:{hash}`: 总数缓存
- `search:suggestions:{prefix}`: 搜索建议

### 错误处理
- 400: 搜索参数无效
- 422: 搜索关键词过短或过长
- 429: 搜索频率限制
- 500: 搜索服务不可用

### 安全考虑
- 搜索关键词SQL注入防护
- 搜索频率限制 (每用户每分钟30次)
- 敏感词过滤
- XSS防护在高亮功能中